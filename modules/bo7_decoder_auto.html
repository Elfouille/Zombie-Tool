<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BO7 – Décodeur (AUTO)</title>
<style>
  body{margin:0;background:#0b0c10;color:#fff;font-family:Arial,sans-serif;display:flex;justify-content:center;padding:20px}
  .panel{background:#14161d;border:1px solid #2a2f3a;border-radius:16px;padding:20px;max-width:980px;width:100%}
  h2{text-align:center;margin:0 0 10px}
  .hint{opacity:.85;font-size:13px;margin-bottom:10px;text-align:center}

  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px}
  .sym{background:#0f1117;border:2px solid #2a2f3a;border-radius:14px;padding:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.15s}
  .sym:hover{border-color:#7aa2ff}
  .sym svg{width:64px;height:64px}

  .sym.used{border-color:rgba(155,92,255,.55)}
  .sym.active{border-color:#9b5cff;box-shadow:0 0 14px rgba(155,92,255,.7)}
  .sym.used svg,.sym.active svg{filter:drop-shadow(0 0 6px rgba(155,92,255,.8))}

  .sym svg line,.sym svg rect,.sym svg path{stroke:#fff !important;fill:none !important;stroke-linecap:square;stroke-linejoin:miter}
  .sym svg circle{fill:#fff !important;stroke:none !important}

  /* Desktop controls */
  .controls{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
  button{background:#0f1117;color:#fff;border:1px solid #2a2f3a;border-radius:10px;padding:10px 14px;cursor:pointer}
  button:hover{border-color:#7aa2ff}

  .output{margin:0;font-size:18px;line-height:1.35}
  code{background:#000;padding:4px 8px;border-radius:6px}
  .small{opacity:.8;font-size:13px}
  .badge{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid #2a2f3a;background:#0f1117;margin-left:8px}
  .ok{border-color:rgba(155,92,255,.9); box-shadow:0 0 10px rgba(155,92,255,.25)}
  .warn{border-color:rgba(255,180,0,.9)}
  .row{margin-top:8px}
  .big{font-size:22px}

  .toggle{display:flex;align-items:center;gap:10px;margin-top:8px;justify-content:center;font-size:13px;opacity:.9}
  .toggle input{transform:scale(1.2)}

  /* Anti double-tap / sélection */
  .sym, button{
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    touch-action: manipulation;
  }

  html, body{overscroll-behavior: contain;}

  :root{
    --infoH: 15svh; /* ✅ 15% */
    --tileH: auto;
  }

  .bottomPanel{
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    height: var(--infoH);
    z-index: 55;
    background: rgba(11,12,16,.95);
    border-top: 1px solid #2a2f3a;
    padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
    backdrop-filter: blur(8px);
    overflow: hidden;
  }

  @media (max-width: 600px){
    body{padding:12px}

    html, body{
      height: 100svh;
      overflow: hidden; /* ✅ pas de scroll global */
    }

    .panel{
      height: 100%;
      overflow: hidden;
      padding: 14px;
    }

    .grid{
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(5, 1fr); /* ✅ 5 lignes fixes */
      gap: 8px;
      overflow: hidden;
    }

    .sym{
      height: var(--tileH);
      padding: 10px;
      border-radius: 14px;
    }

    .sym svg{
      width: min(64px, 18vw);
      height: auto;
      aspect-ratio: 1 / 1;
      max-height: calc(var(--tileH, 120px) - 18px);
    }

    /* Boutons FIXED au-dessus du panneau infos */
    .controls{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 24px);
      max-width: 980px;

      bottom: calc(var(--infoH) + 10px);
      z-index: 70;

      margin-top: 0;
      padding: 10px 0;
      background: linear-gradient(transparent, rgba(11,12,16,.92) 30%);
      backdrop-filter: blur(6px);
      justify-content: center;
    }

    button{
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 12px;
    }

    .output{font-size:16px}
    .big{font-size:20px}
  }

  @media (hover: none){
    .sym:hover{border-color:#2a2f3a; box-shadow:none}
    button:hover{border-color:#2a2f3a}
  }
</style>
</head>

<body>
<div class="panel">
  <h2>BO7 – Décodeur Symboles</h2>
  <div class="hint">Clique les symboles dans l’ordre affiché en jeu</div>

  <div class="toggle">
    <label><input type="checkbox" id="autoToggle" checked> Mode AUTO</label>
  </div>

  <div class="grid" id="grid"></div>

  <div class="controls" id="controls">
    <button id="undoBtn">⌫ Retour</button>
    <button id="clearBtn">Effacer</button>
  </div>

  <div class="bottomPanel" id="bottomPanel">
    <div class="output" id="out"></div>
  </div>
</div>

<script>
const PAIR_TO_WORD = [
  {a:"G", b:"I", word:"ENGINE"},
  {a:"L", b:"A", word:"LAUNCH"},
  {a:"E", b:"T", word:"ROCKET"},
  {a:"O", b:"N", word:"WEAPON"},
];

const MAX_LETTERS = 6;

const glyphs = [
  {svg:`<rect x="10" y="10" width="80" height="80" stroke-width="10"/>`, num:"04", letter:"E"},
  {svg:`<rect x="10" y="10" width="80" height="80" stroke-width="10"/><circle cx="50" cy="50" r="10"/>`, num:"13", letter:"N"},
  {svg:`<line x1="10" y1="10" x2="10" y2="90" stroke-width="10"/><line x1="10" y1="90" x2="90" y2="90" stroke-width="10"/>`, num:"02", letter:"C"},
  {svg:`<line x1="20" y1="20" x2="20" y2="80" stroke-width="10"/><line x1="20" y1="20" x2="80" y2="20" stroke-width="10"/><line x1="20" y1="80" x2="80" y2="80" stroke-width="10"/><circle cx="55" cy="50" r="8"/>`, num:"14", letter:"O"},
  {svg:`<line x1="10" y1="10" x2="10" y2="70" stroke-width="10"/><line x1="90" y1="10" x2="90" y2="70" stroke-width="10"/><line x1="10" y1="70" x2="90" y2="70" stroke-width="10"/><circle cx="50" cy="45" r="7"/>`, num:"10", letter:"K"},

  {svg:`<line x1="10" y1="10" x2="10" y2="90" stroke-width="10"/><line x1="10" y1="90" x2="90" y2="90" stroke-width="10"/><circle cx="55" cy="55" r="10"/>`, num:"11", letter:"L"},
  {svg:`<line x1="90" y1="10" x2="90" y2="90" stroke-width="10"/><line x1="10" y1="90" x2="90" y2="90" stroke-width="10"/>`, num:"00", letter:"A"},
  {svg:`<line x1="70" y1="20" x2="30" y2="50" stroke-width="10"/><line x1="70" y1="80" x2="30" y2="50" stroke-width="10"/>`, num:"20", letter:"U"},
  {svg:`<line x1="10" y1="10" x2="10" y2="90" stroke-width="10"/><line x1="10" y1="10" x2="90" y2="10" stroke-width="10"/>`, num:"08", letter:"I"},
  {svg:`<line x1="30" y1="20" x2="70" y2="50" stroke-width="10"/><line x1="30" y1="80" x2="70" y2="50" stroke-width="10"/>`, num:"19", letter:"T"},

  {svg:`<line x1="10" y1="30" x2="50" y2="80" stroke-width="10"/><line x1="90" y1="30" x2="50" y2="80" stroke-width="10"/><circle cx="50" cy="45" r="7"/>`, num:"22", letter:"W"},
  {svg:`<line x1="90" y1="10" x2="90" y2="90" stroke-width="10"/><line x1="10" y1="10" x2="90" y2="10" stroke-width="10"/>`, num:"06", letter:"G"},
  {svg:`<line x1="90" y1="10" x2="90" y2="90" stroke-width="10"/><line x1="10" y1="10" x2="90" y2="10" stroke-width="10"/><circle cx="50" cy="50" r="7"/>`, num:"15", letter:"P"},
  {svg:`<line x1="10" y1="30" x2="10" y2="90" stroke-width="10"/><line x1="90" y1="30" x2="90" y2="90" stroke-width="10"/><line x1="10" y1="30" x2="90" y2="30" stroke-width="10"/>`, num:"07", letter:"H"},
  {svg:`<line x1="10" y1="10" x2="10" y2="90" stroke-width="10"/><line x1="10" y1="10" x2="90" y2="10" stroke-width="10"/><circle cx="55" cy="55" r="10"/>`, num:"17", letter:"R"},
];

const grid = document.getElementById("grid");
const out = document.getElementById("out");
const undoBtn = document.getElementById("undoBtn");
const clearBtn = document.getElementById("clearBtn");
const autoToggle = document.getElementById("autoToggle");
const controls = document.getElementById("controls");
const bottomPanel = document.getElementById("bottomPanel");

let picked = [];
let tiles = [];
let autoLock = null;

function applyHighlight(){
  tiles.forEach(t=>t.classList.remove("used","active"));
  picked.forEach(p => tiles[p.tileIndex]?.classList.add("used"));
  if (picked.length) tiles[picked[picked.length-1].tileIndex]?.classList.add("active");
}

function detectConfirmedWord(letters){
  const set = new Set(letters);
  const found = [];
  for (const rule of PAIR_TO_WORD){
    if (set.has(rule.a) && set.has(rule.b)) found.push(rule.word);
  }
  if (found.length === 1) return found[0];
  if (found.length > 1) return "AMBIGU";
  return null;
}

function buildOrdered(word, pickedList){
  const buckets = new Map();
  for (const it of pickedList){
    if (!buckets.has(it.letter)) buckets.set(it.letter, []);
    buckets.get(it.letter).push(it);
  }
  for (const [k, arr] of buckets.entries()) buckets.set(k, arr.slice());

  const orderedNums = [];
  const orderedLetters = [];
  const missing = [];

  for (const ch of word){
    const arr = buckets.get(ch) || [];
    if (arr.length){
      const it = arr.shift();
      orderedLetters.push(ch);
      orderedNums.push(it.num);
    } else {
      orderedLetters.push(ch);
      orderedNums.push("--");
      missing.push(ch);
    }
  }
  return { orderedLetters: orderedLetters.join(""), orderedNums: orderedNums.join("/"), missing };
}

function fillMissing(word){
  if (!word || word === "AMBIGU") return;
  if (autoLock === word) return;

  const have = new Map();
  for (const it of picked) have.set(it.letter, (have.get(it.letter) || 0) + 1);

  const need = new Map();
  for (const ch of word) need.set(ch, (need.get(ch) || 0) + 1);

  const missing = [];
  for (const [ch, n] of need.entries()){
    const h = have.get(ch) || 0;
    for (let i=0; i<Math.max(0, n - h); i++) missing.push(ch);
  }
  if (!missing.length) { autoLock = word; return; }

  for (const ch of word){
    if (picked.length >= MAX_LETTERS) break;
    const idxNeed = missing.indexOf(ch);
    if (idxNeed !== -1){
      const gi = glyphs.findIndex(g => g.letter === ch);
      if (gi !== -1){
        picked.push({letter: ch, num: glyphs[gi].num, tileIndex: gi});
        missing.splice(idxNeed, 1);
        if (!missing.length) break;
      }
    }
  }
  autoLock = word;
  applyHighlight();
}

function render(){
  const lettersRaw = picked.map(x=>x.letter).join("");
  const confirmed = detectConfirmedWord(picked.map(x=>x.letter));

  let badge = `<span class="badge">—</span>`;
  let orderedHtml = "";

  if (confirmed === "AMBIGU"){
    badge = `<span class="badge warn">AMBIGU</span>`;
    autoLock = null;
  } else if (confirmed){
    badge = `<span class="badge ok">${confirmed}</span>`;
    const ordered = buildOrdered(confirmed, picked);
    const missBadge = ordered.missing.length
      ? `<span class="badge warn">codes manquants</span>`
      : `<span class="badge ok">OK</span>`;

    orderedHtml = `
      <div class="row">
        <div>Mot : <b class="big">${ordered.orderedLetters}</b> ${missBadge}</div>
        <div>Code : <code>${ordered.orderedNums}</code></div>
      </div>
    `;
  } else {
    autoLock = null;
  }

  out.innerHTML = `
    <div>Lettres : <b>${lettersRaw || "—"}</b> <span class="small">(${picked.length}/${MAX_LETTERS})</span></div>
    <div class="row">Mot : ${badge}</div>
    ${orderedHtml}
  `;
}

function maybeAuto(){
  if (!autoToggle.checked) return;
  const confirmed = detectConfirmedWord(picked.map(x=>x.letter));
  if (confirmed && confirmed !== "AMBIGU"){
    const before = picked.length;
    fillMissing(confirmed);
    if (picked.length !== before) applyHighlight();
  }
}

function undo(){
  if(!picked.length) return;
  picked.pop();
  autoLock = null;
  applyHighlight();
  render();
  maybeAuto();
  render();
}

function clearAll(){
  picked = [];
  autoLock = null;
  applyHighlight();
  render();
}

/* ✅ Calcul dynamique (iframe-safe) : mesure réelle de l'espace */
function fitTilesMobile(){
  if (window.innerWidth > 600) {
    document.documentElement.style.setProperty("--tileH", "auto");
    return;
  }

  const vh = (window.visualViewport?.height || window.innerHeight);

  const gridTop = grid.getBoundingClientRect().top;
  const controlsH = controls.getBoundingClientRect().height;
  const infoH = bottomPanel.getBoundingClientRect().height;

  const bottomLimit = vh - infoH - controlsH - 12;     // 12px marge
  const avail = bottomLimit - gridTop;

  const rows = 5; // 15 symboles => 5 lignes de 3
  const gap = 8;
  const tileH = Math.max(52, Math.floor((avail - gap*(rows-1)) / rows));

  document.documentElement.style.setProperty("--tileH", tileH + "px");
}

glyphs.forEach((g, idx) => {
  const d = document.createElement("div");
  d.className = "sym";
  d.innerHTML = `<svg viewBox="0 0 100 100">${g.svg}</svg>`;
  d.onclick = () => {
    if (navigator.vibrate) navigator.vibrate(15);
    if (picked.length >= MAX_LETTERS) return;
    picked.push({letter:g.letter, num:g.num, tileIndex: idx});
    autoLock = null;
    applyHighlight();
    render();
    maybeAuto();
    render();
  };
  grid.appendChild(d);
  tiles.push(d);
});

undoBtn.onclick = undo;
clearBtn.onclick = clearAll;

autoToggle.onchange = () => {
  autoLock = null;
  maybeAuto();
  render();
};

window.addEventListener("resize", fitTilesMobile);
window.visualViewport?.addEventListener("resize", fitTilesMobile);
window.visualViewport?.addEventListener("scroll", fitTilesMobile);

applyHighlight();
render();
setTimeout(fitTilesMobile, 0);
</script>
</body>
</html>
